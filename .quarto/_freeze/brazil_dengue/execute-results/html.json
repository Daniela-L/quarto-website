{
  "hash": "984ec24e410b3d4686951347d104467a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"1b_DengueData\"\nauthor: \"Daniela Luhrsen, Rachel Lowe and Raquel Lana\"\ndate: \"2022-10-27\"\noutput: github_document\neditor_options: \n  chunk_output_type: console\nmessage: true\neditor: \n  markdown: \n    wrap: 80\n---\n\n\n\n\nThis document aims at introducing dengue data to someone with no previous\nexperience. Before starting it is necessary to have the health data,\ninstructions on how to obtain these are in the ReadMe of this project.\n\nThe steps include:\n\n0.  Downloading the data\n1.  Getting to know the data: detect differences between different datasets\n2.  Information on the patients: Age, Sex, Pregnancy, Race\n3.  Information ono the case: classification, confirmation criteria, dengue\n    category, exam type, evolution of the case\n4.  Timeline of the dengue case: distribution throughout the year, duration of\n    cases, course of the disease\n5.  Mapping spatially: Absolute cases, incidence\n\nAlong the way, each topic will be divided into 3:\n\n-   ![](images/idea-02.png){width=\"25\"} indicates that you will learn something\n\n-   ![](images/eye-01.png){width=\"24\"} indicates that you will see the data in a\n    plot\n\n-   ![](images/filter-01.png){width=\"20\"} indicates that there is a opportunity\n    to filter data (if necessary).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#load packages\npackages  <- c(\"tidyverse\", \"microdatasus\", \"foreign\", \"readr\", \"dplyr\", \"purrr\",\n               \"ggplot2\",\"tidyr\", \"lubridate\",\"geobr\", \"stringr\", \"patchwork\",\n               \"arsenal\", \"read.dbc\")\ninvisible(install.packages(setdiff(packages, rownames(installed.packages()))))\ninvisible(lapply(packages, function(pkg) suppressMessages(require(pkg, character.only = TRUE))))\n\n# other options\noptions(scipen = 999)\noptions(timeout = 2000)\n\n# load functions\nfiles.sources <-  list.files(\"R/\")\ninvisible(sapply(paste0(\"R/\", files.sources), source))\n```\n:::\n\n\n\n\n# Download the data by microdatasus\n\nAs described in the ReadMe, the health data from Brazil can be downloaded by\nmany different methods: *microdatasus*, PySUS or by Filezilla [FTP\nlink](ftp.datasus.gov.br). In this script, the data will be downloaded with the\nhelp of the package *microdatasus*, the following code block is an example that\nwill download the data for the year 2015 and 2021. The dengue database is heavy\nand it can take time to download it. It is therefor recommended to download and\nsave it before the analysis and to simply load the datasets once you do the\nanalysis. (In the case of this script, run it once entirely, and then you can\ncomment out the first code block to not download the same data over and over.)\n\nSometimes problems with the variables occur when downloading data from mutiple\nyears (e.g. 2012 to 2015). The developer are already aware of this. For now,\ndownload each year one by one, then import all years using bind_rows and use an\nargument to import all variables as a character.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# den15 <- fetch_datasus(year_start = 2015, year_end = 2015, information_system = \"SINAN-DENGUE\")\n# den21 <- fetch_datasus(year_start = 2021, year_end = 2021, information_system = \"SINAN-DENGUE\")\nden15 <- readRDS(\"data/den15.rds\")\nden21 <- readRDS(\"data/den21.rds\")\n```\n:::\n\n\n\n\n#### Understanding the data structure\n\n![](images/idea-02.png){width=\"25\"} Specifically, it contains 139 variables, the\nexplanation for each variable can be found on the [SINAN\nwebpage](portalsinan.saude.gov.br/images/documentos/Agravos/Dengue/DIC_DADOS_ONLINE.pdf)\nfrom the Ministry of Health of Brazil. However, it is only available in\nPortuguese. A translation into English can be found in [this csv\nfile](Workspace/Dictionary_Dengue.csv). This file also contains the\ndecodification for all numerical categories. A small overview of this file can\nbe seen below:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvarEng <- read_csv(\"workspace/Dictionary_Dengue.csv\")\nknitr::kable(head(varEng[,1:4]))\n```\n\n::: {.cell-output-display}\n\n\n|Var        |Eng                                  |1   |2  |\n|:----------|:------------------------------------|:---|:--|\n|ACIDO_PEPT |Preexistence of peptic acid illness  |Yes |No |\n|ALRM_ABDOM |Alarm sign: Abdominal pain           |Yes |No |\n|ALRM_HEMAT |Alarm sign: Hematocrit increase      |Yes |No |\n|ALRM_HEPAT |Alarm sign: Hepatomegaly             |Yes |No |\n|ALRM_HIPOT |Alarm sign: Hipotension              |Yes |No |\n|ALRM_LETAR |Alarm sign: Lethargy or irritability |Yes |No |\n\n\n:::\n:::\n\n\n\n\nSome of these variables are mandatory to notify, others are not, which leads to\nincomplete datasets. The dataframe **NAcount** shows the percentage of NA-values\nfor each variable, below you can see it graphically for some of the variables.\nHere, we chose as the main database to explore the variables, den15, a database\nyou can download by the FTP link.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNAcount <- den15 %>% map(~mean(is.na(.)))\nNAcount <- data.frame(unlist(NAcount))\nNAcount[\"var\"] <- rownames(NAcount)\n```\n:::\n\n\n\n\n![](images/eye-01.png){width=\"24\"} You can visualise it here.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- ggplot(NAcount[35:55,], aes(x = reorder(var, unlist.NAcount.), y = unlist.NAcount.))+\n  geom_bar(stat = \"identity\", width = 0.9, position = position_dodge(width = 5))+\n  ylab(\"Percentage of NAs in each column\")+\n  xlab(\"Variables\")\np + coord_flip()\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_NACount-1.png){width=672}\n:::\n:::\n\n\n\n\nThe variables with complete datasets are:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nNAcount$var[NAcount$unlist.NAcount. == 0]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"TP_NOT\"     \"ID_AGRAVO\"  \"DT_NOTIFIC\" \"SEM_NOT\"    \"NU_ANO\"    \n[6] \"SG_UF_NOT\"  \"ID_MUNICIP\" \"SEM_PRI\"    \"NU_IDADE_N\"\n```\n\n\n:::\n:::\n\n\n\n\n![](images/filter-01.png){width=\"20\"} To avoid working with unnecessary data, it\nis useful to filter out the variables that will not be used. Below is a line of\ncode on how to select only the needed variables.\n\nChange this list as needed!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsel_var <- c(\"DT_NOTIFIC\",  \"ID_MUNICIP\",  \"DT_SIN_PRI\", \"DT_NASC\", \"NU_IDADE_N\", \n             \"CS_SEXO\", \"CS_GESTANT\", \"CS_RACA\", \"ID_MN_RESI\",  \"COMUNINF\", \n             \"CLASSI_FIN\", \"CRITERIO\",  \"EVOLUCAO\", \"DT_OBITO\", \"DT_SORO\",  \n             \"DT_ENCERRA\", \"RES_CHIKS1\",\"RES_CHIKS2\", \"RESUL_PRNT\",\"RESUL_SORO\",\"RESUL_NS1\",\n             \"RESUL_VI_N\", \"RESUL_PCR_\",\"HISTOPA_N\",\"IMUNOH_N\", \"MUNICIPIO\")\n\nden15 <- den15 %>% select(all_of(sel_var))\n```\n:::\n\n\n\n\n<!-- ### VER Ver duplicados antes aqui, ver a comparaçao entre os dados do FTP e solicitados. Parece que precisa de data de nascimento para deduplicar. Probably we can't deduplicate the files from FTP. Check well the files from the MS. -->\n\n<!-- DL: Tego que terminar esto -->\n\nThere is library in Python that can help\nhttps://pypi.org/project/pandas-dedupe/. ver 2015, esse veio do ministério\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Filtro: duplicidade ----\n# den15 %>%\n#   distinct(NU_NOTIFIC, DT_NOTIFIC, ID_MUNICIP, .keep_all = T) %>% count()\n#\n# den15 %>%\n#   distinct(NU_NOTIFIC, DT_NOTIFIC, ID_MUNICIP, DT_NASC, ID_UNIDADE, .keep_all = T) %>% count()\n```\n:::\n\n\n\n\n# Information on the patient\n\n### *Age*\n\n![](images/idea-02.png){width=\"25\"} For dengue, there are two methods to obtain\nthe age of the patients. First, using the data about the patients birth-date,\nwhich is provided in the variable **DT_NASC**. The age can be calculated by\nsubtracting the birth-date from the notification date.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nden15 <- den15 %>%\n    mutate(AGE_BIRTHDAY =\n             ifelse(format(den15$DT_NASC, \"%m-%d\") > format(den15$DT_NOTIFIC, \"%m-%d\"),\n                    year(den15$DT_NOTIFIC)-year(den15$DT_NASC)-1,\n                    year(den15$DT_NOTIFIC)-year(den15$DT_NASC)))\n```\n:::\n\n\n\n\n![](images/eye-01.png){width=\"24\"} You can visualise it here\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(den15, aes(x = AGE_BIRTHDAY))+\n  geom_histogram(binwidth = 1, fill = \"lightblue\",color=\"black\", alpha = 0.7)+\n  annotate(\"text\", x = 100, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(den15$AGE_BIRTHDAY)), \" NA values\"))+\n  labs(x=\"Age [years]\", y=\"Count\", title=\"Age distribution according to the birthday field\")+\n  theme_light()\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_AgeBirthday-1.png){width=672}\n:::\n:::\n\n\n\n\n![](images/idea-02.png){width=\"25\"} However, **DT_NASC** is not a mandatory\nvariable, thus, there are many missing values. Instead, **NU_IDADE_N** can be\nused. **NU_IDADE_N** is codified as follows:\n\n-   the first number indicates what \"dimension\" it is using. 1= Hour, 2= day, 3=\n    month, 4= year.\n-   the last numbers indicate the age. The age can be \"decodified\" with the\n    below command line.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nden15  <- den15 %>%\n  mutate(AGE_CODE = case_when(NU_IDADE_N < 120 ~ as.numeric(NU_IDADE_N), # assumes that non-codified data means that the age in years was given\n                           NU_IDADE_N >= 120 & NU_IDADE_N < 1000 ~ NA_real_,\n                           NU_IDADE_N >= 1000 & NU_IDADE_N < 2366 ~ 0,\n                           NU_IDADE_N >= 2366 & NU_IDADE_N < 3000 ~ NA_real_,\n                           NU_IDADE_N >= 3000 & NU_IDADE_N < 3013 ~ 0,\n                           NU_IDADE_N >= 3013 & NU_IDADE_N < 4000 ~ NA_real_,\n                           NU_IDADE_N >= 4000 & NU_IDADE_N < 4120 ~ as.numeric(NU_IDADE_N - 4000),\n                           NU_IDADE_N >= 4120 ~ NA_real_,\n                           TRUE ~ NA_real_))\n\nggplot(den15[den15$AGE_CODE < 120,], aes(x = AGE_CODE))+\n  geom_histogram(binwidth = 1, fill = \"lightblue\",color=\"black\", alpha = 0.7)+\n  annotate(\"text\", x = 100, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(den15$AGE_CODE)), \" NA values\"))+\n  labs(x=\"Age [years]\", y=\"Count\",\n       title=\"Age distribution according to the codified age field\")+\n  theme_light()\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_AgeCode-1.png){width=672}\n:::\n:::\n\n\n\n\nThe two histograms are very similar, however there is a noticeable difference in\nthe amount of people aged 0. Below are the first few lines of cases where the\ntwo calculated ages differ:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncompare_age <- den15[(den15$AGE_BIRTHDAY - den15$AGE_CODE) >1,] %>%\n  select(DT_NASC, NU_IDADE_N, AGE_CODE, AGE_BIRTHDAY)\nknitr::kable(head(compare_age[!is.na(compare_age$DT_NASC),]))\n```\n\n::: {.cell-output-display}\n\n\n|     |DT_NASC    | NU_IDADE_N| AGE_CODE| AGE_BIRTHDAY|\n|:----|:----------|----------:|--------:|------------:|\n|16   |1961-02-03 |       2001|        0|           53|\n|351  |2001-08-21 |       4010|       10|           13|\n|472  |1994-12-24 |       2001|        0|           20|\n|1100 |2009-02-26 |       3002|        0|            6|\n|1252 |1991-07-08 |       2001|        0|           23|\n|1395 |2000-06-11 |       2001|        0|           14|\n\n\n:::\n:::\n\n\n\n\n![](images/filter-01.png){width=\"20\"} There are many people with an age code of\n0, but with an birthdate, that indicates a diferent age. Another common way to\nfilter inconsistencies is to discard people above the age of 120.\n\n<!-- Introduce line of code to filter. -->\n\n### *Sex of the patients*\n\n![](images/idea-03.png){width=\"23\"} The sex of the patients is given by\n**CS_SEXO**.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nden15 <- den15 %>%\n  mutate(CS_SEXO = as.factor(case_when(CS_SEXO == \"F\" ~ \"Female\",\n                                       CS_SEXO == \"M\" ~ \"Male\",\n                                       CS_SEXO == \"I\" ~ \"Ignored\",\n                                       TRUE ~ \"NA\")))\n```\n:::\n\n\n\n\n![Learn](images/eye.png){width=\"30\"} A bar plot of its distribution can be seen\nbelow:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(den15, aes(x = CS_SEXO, fill=CS_SEXO))+\n  geom_bar()+\n  ggtitle(\"Sex distribution of dengue cases in 2015\")+\n  labs(x = \"Sex of the patient\", y = \"Count\", fill=\"Sex\")+\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(den15$CS_SEXO)), \" NA values\"))+\n  theme_light()\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Sex-1.png){width=672}\n:::\n:::\n\n\n\n\n### *Pregnancy*\n\n![](images/idea-03.png){width=\"23\"} Another related variable is **CS_GESTANT**,\nwhich indicates whether the patient is pregnant. Since only women below a\ncertain age can get pregnant this is another way to check for inconsistencies.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npregnant <- den15 %>%\n  filter((CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\nmpreg <- den15 %>%\n  filter(CS_SEXO == \"M\" & (CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\npover50 <- den15 %>%\n  filter(AGE_CODE > 50 & (CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n```\n:::\n\n\n\n\n![Filter](images/filter.png){width=\"20\"} Out of 13382 pregnant patients,\nthere are 0 pregnant males and 764 pregnant women over the age\nof 50. Again, depending on the aim of the study, these patients could be\nexcluded using the following line.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nden15 <- den15 %>%\n  filter(!(CS_GESTANT %in% c(\"1\", \"2\", \"3\", \"4\") & CS_SEXO == \"M\") & \n           !(CS_GESTANT %in% c(\"1\", \"2\", \"3\", \"4\") & AGE_CODE > 50))\n```\n:::\n\n\n\n\n### *Race/Color of the patients*\n\n![Learn](images/idea.png){alt=\"Learn\" width=\"20\"} The race/color of the patient\nis given by **CS_RACA**.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nden15 <- den15 %>%\n    mutate(CS_RACA = as.factor(case_when(CS_RACA == 1 ~ \"White\",\n                                       CS_RACA == 2 ~ \"Black\",\n                                       CS_RACA == 3 ~ \"Yellow\",\n                                       CS_RACA == 4 ~ \"Brown\",\n                                       CS_RACA == 5 ~ \"Indigenous\",\n                                       CS_RACA == 9 ~ \"Ignored\",\n                                       TRUE ~ \"NA\")))\n```\n:::\n\n\n\n\n![](images/eye.png){alt=\"Learn\" width=\"30\"}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(den15, aes(x = CS_RACA, fill=CS_RACA)) +\n  geom_bar() +\n  ggtitle(\"Race/Color distribution of dengue cases in 2015\") +\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = CS_RACA),\n            position = position_stack(vjust = 0.5)) +\n  labs(x=\"Race/Color of the patient\", y=\"Count\",fill=\"Race/Color\")\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Race_Visualise-1.png){width=672}\n:::\n:::\n\n\n\n\nNote the amount of missing values and ignored for race/color.\n\n# Information on the cases\n\n### *Classification of the dengue cases*\n\n![Learn](images/idea.png){width=\"20\"} This database collects all the\n**suspected** cases of dengue, however, not all suspected cases are considered\nas probable or confirmed. The variable **CLASSI_FIN** gives insight about the\nfinal classification and severity of each case. It is important to note that\nsince 2015 there are new classification rules, consequently the codification of\nthis variables changed too. Before 2015 the numbers 1-5 were used, and now 5-13\n(5 always meing \"discarded\"). The code is as follows:\n\n1 - Classic Dengue Fever 2 - Severe Dengue 3 - Dengue Hemorrhagic Fever - DHF\n4 - Dengue Shock Syndrome 5 - Discarded 8 - Inconclusive 10 - Dengue 11 - Dengue\nwith warning signs) 12 - Severe Dengue 13 - Chikungunya\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclassification <- den15 %>%\n   mutate(\n     CLASSI_FIN = as.factor(case_when(CLASSI_FIN == 1 ~ \"Dengue\",\n                                      CLASSI_FIN == 2 ~ \"Severe Dengue\",\n                                      CLASSI_FIN == 3 ~ \"Dengue Hemorrhagic Fever\",\n                                      CLASSI_FIN == 4 ~ \"Dengue Shock Syndrome\",\n                                      CLASSI_FIN == 5 ~ \"Discarded\",\n                                      CLASSI_FIN == 8 ~ \"Inconclusive\",\n                                      CLASSI_FIN == 10 ~ \"Dengue\",\n                                      CLASSI_FIN == 11 ~ \"Dengue with \\nwarning signals\",\n                                      CLASSI_FIN == 12 ~ \"Severe Dengue\",\n                                      CLASSI_FIN == 13 ~ \"Chikungunya\",\n                                      TRUE ~ \"NA\")))\n```\n:::\n\n\n\n\n![](images/eye.png){alt=\"Learn\" width=\"30\"}\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(classification) +\n  geom_bar(aes(x = CLASSI_FIN, fill=CLASSI_FIN)) +\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = CLASSI_FIN),\n            position = position_stack(vjust = 0.5)) +\n  labs(x=\"Classification category\",\n       y=\"Count\",\n       title=\"Final classification of dengue cases in 2021\",\n       fill= \"Classification\")+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Classification_Visualise-1.png){width=672}\n:::\n:::\n\n\n\n\n![Filter](images/filter.png){alt=\"Filter\" width=\"20\"} Almost\n29.1%\nof the cases in 2021 were **discarded**. If a study only considers **probable**\ndengue cases, these discarded cases, as well as those without classification,\nshould be discarded.\n\n### *Confirmation criteria of the cases*\n\n![Learn](images/idea.png){alt=\"Learn\" width=\"20\"} It can be of interest how the\ndengue case are confirmed. Information about the type of confirmation can be\nextracted from the variable **CRITERIO**. In Brazil there are three different\noptions:\n\n-   laboratory exams\n-   clinical epidemiological, which means that a physician talked to the\n    patient.\n-   Unknown\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncriteria <-  den15 %>%\n  count(CRITERIO, name = \"count\") %>%\n  mutate(percentage = prop.table(count),\n         category = c(\"Laboratory\", \"Clinical epidimiological\",\"Under investigation\",\"Unknown\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(criteria, aes(x = category, y = count, fill = category)) +\n  geom_bar(stat = \"identity\") +\n  geom_text(aes(label = paste0(round(percentage * 100, 1), \"%\")),\n            position = position_stack(vjust = 0.5)) +\n  labs(x = \"Confirmation criteria\",\n       y = \"Count\",\n       title = \"Confirmation criteria of dengue cases in 2015\",\n       fill = \"Confirmation Criteria\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_ConfirmationCriteria-1.png){width=672}\n:::\n:::\n\n\n\n\n49.8%\nof the cases were confirmed/discarded via the criteria of *clinical\nepiediomogical*, and\n36.6% via\n*laboratory exams*. A detailed description of which exams are tipically used can\nbe seen in the [exam type section](####exam-type).\n\n![Filter](images/filter.png){alt=\"Filter\" width=\"20\"} If you are interest solely\nin **confirmed** cases, then all cases with unknown or missing criteria have to\nbe dismissed.\n\n### *Categories of dengue*\n\n![Learn](images/idea.png){alt=\"Learn\" width=\"20\"} Based on its classification\nand confirmation criterium, dengue cases can be categorized into 4 different\ncategories. They have been mentioned in the previous sections, but for clarity\nthey are listed and defined here again:\n\n-   *Suspect cases*: all notifications.\n-   *Confirmed cases*: dengue cases confirmed by laboratory or\n    clinic-epidemiological criteria.\n-   *Probable cases*: dengue cases discarding missing values and discarded\n    category of the CLASSI_FIN variable.\n-   *Discarded* category of the CLASSI_FIN variable.\n\n### *Exam type*\n\n![](images/idea-03.png){width=\"23\"} In the case of confirmation via *laboratory\nexams*, there are 9 different possible exams. Each exam has its own variable,\nwith a numerical code that indicates its result:\n\n1.  means the result of the exam is positive\n2.  means the result of the exam is negative\n3.  means the result of the exam is inconclusive\n4.  means the exam was not realized\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexams <- den15 %>%\n  filter(CRITERIO == 1) %>%\n  summarise('Serological exam 1 (Chikungunya)' = sum(!is.na(RES_CHIKS1) & RES_CHIKS1 != 4 ),\n            'Serological exam 2 (Chikungunya)' = sum(!is.na(RES_CHIKS2) & RES_CHIKS2 != 4),\n            'PRNT exam' = sum(!is.na(RESUL_PRNT) & RESUL_PRNT != 4),\n            'Serological exam (dengue)' = sum(!is.na(RESUL_SORO) & RESUL_SORO != 4),\n            'NS1 exam' = sum(!is.na(RESUL_NS1) & RESUL_NS1 != 4),\n            'Viral isolation' = sum(!is.na(RESUL_VI_N) & RESUL_VI_N != 4),\n            'PCR exam' = sum(!is.na(RESUL_PCR_) & RESUL_PCR_ != 4),\n            'Histopatology exam' = sum(!is.na(HISTOPA_N) & HISTOPA_N != 4),\n            'Immunohistochemistry exam' = sum(!is.na(IMUNOH_N) & IMUNOH_N != 4))\nexams <-  data.frame(var= colnames(exams), val= t(exams))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(exams, aes(x = var, y = val, fill=val)) +\n  geom_bar(stat = \"identity\",aes(reorder(var, val), val)) +\n  ggtitle(\"Frequency of each lab exam performed for dengue cases in 2015\") +\n  xlab(\"Exams\") +\n  theme(axis.text.x = element_text(angle = 90, hjust = 0.5, vjust = 0.5))+\n  ylab(\"Count\")\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\nAs can be seen, the serological exam is by far the most used one, followed by\nNS1. The other exams are hardly used.\n\n### *Evolution of case*\n\n![](images/idea-03.png){width=\"23\"} Finally, the variable **EVOLUCAO** defines\nthe outcome of each dengue case.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nevolution <- den15 %>%\n   mutate(\n     EVOLUCAO = as.factor(case_when(EVOLUCAO == 1 ~ \"Cured\",\n                                    EVOLUCAO == 2 ~ \"Death by \\nillness\",\n                                    EVOLUCAO == 3 ~ \"Death by \\nother cause\",\n                                    EVOLUCAO == 4 ~ \"Death under \\ninvestigation\",\n                                    EVOLUCAO == 9 ~ \"Ignored\",\n                                    TRUE ~ \"NA\")))\n\nggplot(evolution) +\n  geom_bar(aes(x = EVOLUCAO, fill= EVOLUCAO)) +\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = EVOLUCAO),\n            position = position_stack(vjust = 0.5)) +\n  labs(x=\"Category\", y = \"Count\", fill=\"Category\", title=\"Final outcomes of dengue cases in 2015\" )\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Evolution-1.png){width=672}\n:::\n:::\n\n\n\n\n# Timeline of dengue cases\n\n### *Notification distribution throughout the year*\n\n![](images/idea-03.png){width=\"23\"} The date of the first time that a potential\ndengue patient contacts the medical authorities is recorded as **DT_NOTIF**.\nThis variable can be used to see clear temporal patterns throughout the year.\nBelow, there is the annual distribution of dengue notifications in 2015, plotted\nat a temporal resolution of epidemiological week. In an epidemiological week,\nthe week starts on Sunday.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndengueEpiWeek <- den15 %>%\n  mutate(epiweek = paste0(sprintf(\"%02d\",epiweek(DT_NOTIFIC)), \"-2015\")) %>%\n  group_by(epiweek) %>%\n  summarise(count = n()) %>%\n  select(epiweek, count)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(dengueEpiWeek, aes(x = epiweek, y = count)) +\n  geom_bar(stat = \"identity\", fill = \"lightblue\", color=\"darkgrey\",alpha = 0.7)+\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(den15$DT_NOTIFIC)), \" NA values\")) +\n  theme_minimal() +\n  labs(title = \"Suspected dengue cases in 2015 by epiweek\",\n       x = \"Epiweek\",\n       y = \"Count\") +\n  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\nThere is a clear seasonal variation, with the peak presenting itself in the\nmiddle of the Autumn season in Brazil.\n\n### *Duration of each dengue case*\n\n![](images/idea-03.png){width=\"23\"} Once the initial notification happens, the\ntimeline of each case starts. The duration of the complete process is delimited\nby the \"closing date\" (**DT_ENCERRA**). Below is a histogram to see the duration\nof each dengue case.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nduration <- as.numeric(den15$DT_ENCERRA - den15$DT_NOTIFIC)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data.frame(duration = duration[duration < 100]), aes(x = duration)) +\n  geom_histogram(bins = 100, fill = \"lightblue\",color=\"black\", alpha = 0.7)+\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(den15$DT_ENCERRA)), \" NA values\")) +\n  labs(title = \"Duration from notification to closing of the case\",\n       x = \"Time [days]\",\n       y = \"Count\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 19525 rows containing non-finite values (`stat_bin()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\nThere is an extremely large amount of cases that end on the 61st day, to be\nspecific\n20.01%. Only\n10.14% of the\ncase take longer than 61 days.\n\n### *Timeline of all other events*\n\n![](images/idea-03.png){width=\"23\"} There are many dates recorded to be able ti\nunderstand the course of the disease. First, symptoms occur (**DT_SIN_PRI**),\nthis occurs before the notification date. Once the doctor notified a dengue\nsuspicion (**DT_NOTIF**) the case needs to be confirmed via an exams, this\nshould happen shortly after the notification. Finally, there must be a closing\ndate (**DT_ENCERRA**) or date of death (**DT_OBITO**). Both of these have to be\nafter the notification date.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntime <- data.frame(A_SYMP = as.numeric(den15$DT_SIN_PRI - den15$DT_NOTIFIC),\n                   B_SORO = as.numeric(den15$DT_SORO - den15$DT_NOTIFIC),\n                   C_DEAD = as.numeric(den15$DT_OBITO - den15$DT_NOTIFIC),\n                   D_TOTAL = as.numeric(den15$DT_ENCERRA - den15$DT_NOTIFIC))\nlong <- gather(time, TYPE, DAYS, A_SYMP:D_TOTAL)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(long, aes(x = TYPE, y = DAYS)) +\n  geom_boxplot() +\n  coord_cartesian(ylim = c(-100, 100)) +\n  labs(x=\"Event\",\n       y=\"Days from the notification day\",\n       title=\"\") +\n  scale_x_discrete(labels = c(\"First Symptoms\", \"Sorological Exam\", \"Death\", \"Case closed\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 4089321 rows containing non-finite values (`stat_boxplot()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n![](images/filter-01.png){width=\"20\"} Most dates should fall within a few days\nbefore the notification day or within two months after it. However, looking at\nthe boxplots, this is clearly not the case. If one wants to work with the\ntimeline of dengue cases, these erroneous cases need to be removed, e.g. someone\ndying before the notification date or someone having their first symptoms on the\n215-04-03.\n\n# Mapping spatially\n\n### *Absolute cases*\n\n![](images/idea-03.png){width=\"23\"} There is of course also spatial data in the\ndatasets. Before beginning the analysis, it is necessary to download the\nshapefiles of Brazils municipalities. This can be done via the *geobr* package\n(more info on this in 0_DownloadData.md). However, the municipality code given\nby geobr is one digit too long and has to be shortened to 6 digits.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmuni <- read_municipality(code_muni = \"all\", year = 2015, showProgress = FALSE) %>%\n  mutate(code_muni = str_sub(code_muni, end = 6))\n```\n:::\n\n\n\n\nIn total, the dataset refers to 4 different locations:\n\n-   **ID_MUNICIP** is the municipality where the case is recorded.\n-   **ID_MN_RESI** is the municipality of residence of the patient.\n-   **COMUNINF** is the probable municipality of infection.\n-   **MUNICIPIO** is the municipality of the hospital (if hospitalized).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnoti <- as.data.frame(table(den15$ID_MUNICIP, dnn = list(\"code_muni\")), responseName = \"noti_muni\")\ninfec <- as.data.frame(table(den15$COMUNINF, dnn = list(\"code_muni\")), responseName = \"infec_muni\")\nresi <- as.data.frame(table(den15$ID_MN_RESI, dnn = list(\"code_muni\")), responseName = \"resi_muni\")\nhosp <- as.data.frame(table(den15$MUNICIPIO, dnn = list(\"code_muni\")), responseName = \"hosp_muni\")\n\nallmuni <- left_join(muni, noti) %>%\n  left_join(., infec) %>%\n  left_join(., resi) %>%\n  left_join(., hosp)\n\ncols <- c(\"green\", \"yellow\",\"orange\",\"red\", \"black\")\nbreaks <- c(0,10,100,1000,10000,100000)\nnoti <- ggplot(allmuni) +\n  ggtitle(\"Notification municipality\")+\n  geom_sf( aes(fill=noti_muni), size=.15, show.legend = TRUE) +\n  scale_fill_stepsn(breaks = breaks,\n                    colours = cols,\n                    values= scales::rescale(breaks))\n\ninfec <- ggplot(allmuni) +\n  ggtitle(\"Probable infections municipality\")+\n  geom_sf( aes(fill=infec_muni), size=.15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks,\n                    colours = cols,\n                    values= scales::rescale(breaks))\n\nresi <- ggplot(allmuni) +\n  ggtitle(\"Residence municipality\")+\n  geom_sf( aes(fill=resi_muni), size=.15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks,\n                    colours = cols,\n                    values= scales::rescale(breaks))\n\nhosp <- ggplot(allmuni) +\n  ggtitle(\"Hospitalizations municipality\")+\n  geom_sf( aes(fill=hosp_muni), size=.15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks,\n                    colours = cols,\n                    values= scales::rescale(breaks))\n\n#using the patchwork library, the plots can be displayed next to each other\n(noti+infec)/(resi+hosp)\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Plot-1.png){width=672}\n:::\n:::\n\n\n\n\nDepending on the aim of the study, different variables can be important. For\nexample, if your work aims to understand the dengue prevalence, the municipality\nof residence is the most suitable. However, if you need to evaluate the\nhealthcare infrastructure, the municipality of hospitalisation could be more\nsuitable.\n\n### *Calculate the incidence*\n\n![](images/idea-03.png){width=\"23\"} Sometimes, having the absolute values is\nhelpful. But other times, the number of dengue cases are highly dependent on the\nnumber of inhabitants and then the incidence is used. The incidence describes\nhow many dengue cases occurred per 100.000 inhabitants.\n\nFor this, the population data needs to be loaded from\n[IBGE](https://www.ibge.gov.br/estatisticas/sociais/populacao/9103-estimativas-de-populacao.html?edicao=31551&t=resultados)\neither manually or using the local function \"get_br_pop_data\" (instructions can\nbe viewed in 0_DownloadData.md).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_br_pop_data(2015, save=F)\n\nallmuni <-  left_join(allmuni, pop_2015[c(\"code_muni\",\"pop\")], by=\"code_muni\")\nallmuni$pop <- as.numeric(allmuni$pop)\n```\n:::\n\n\n\n\nThe incidence is then calculated by dividing the dengue cases by the population\nof each municipality and multiplicating it by 100.000.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nallmuni$noti_inc <- allmuni$noti_muni / allmuni$pop * 100000\nallmuni$infec_inc <- allmuni$infec_muni / allmuni$pop * 100000\nallmuni$resi_inc <- allmuni$resi_muni / allmuni$pop * 100000\nallmuni$hosp_inc <- allmuni$hosp_muni / allmuni$pop * 100000\n\n# Population\nggplot(allmuni) +\n  ggtitle(\"Population in Brazil\")+\n  geom_sf( aes(fill = pop), size = .15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks,\n                    colours = cols,\n                    values= scales::rescale(breaks))\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Incidence-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# Incidence\nbreaks2 <- c(0,5,25,50,100, 250)\nnoti_inc <- ggplot(allmuni) +\n  ggtitle(\"Incidence of dengue notifications in 2015\")+\n  geom_sf( aes(fill = noti_inc), size = .15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks2,\n                    colours = cols,\n                    values = scales::rescale(breaks2))\ninfec_inc <- ggplot(allmuni) +\n  ggtitle(\"Incidence of probable dengue infections in 2015\")+\n  geom_sf( aes(fill = infec_inc), size = .15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks2,\n                    colours = cols,\n                    values = scales::rescale(breaks2))\nresi_inc <- ggplot(allmuni) +\n  ggtitle(\"Incidence of residents with dengue in 2015\")+\n  geom_sf( aes(fill = resi_inc), size = .15, show.legend = TRUE)  +\n  scale_fill_stepsn(breaks = breaks2,\n                    colours = cols,\n                    values = scales::rescale(breaks2))\nhosp_inc <- ggplot(allmuni) +\n  ggtitle(\"Incidence of dengue hospitalizations in 2015\")+\n  geom_sf( aes(fill = hosp_inc), size = .15, show.legend = TRUE) +\n  scale_fill_stepsn(breaks = breaks2,\n                    colours = cols,\n                    values = scales::rescale(breaks2))\n\n(noti_inc+infec_inc)/(resi_inc+hosp_inc)\n```\n\n::: {.cell-output-display}\n![](brazil_dengue_files/figure-html/Dengue_Incidence-2.png){width=672}\n:::\n:::\n",
    "supporting": [
      "brazil_dengue_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}