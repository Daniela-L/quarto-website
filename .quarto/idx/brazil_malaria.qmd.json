{"title":"Malaria in Brazil","markdown":{"yaml":{"title":"Malaria in Brazil","author":"Daniela Luhrsen, Rachel Lowe and Raquel Lana","date":"2022-11-18","output":"github_document","editor_options":{"chunk_output_type":"console"}},"headingText":"Setting up the R environment","containsRefs":false,"markdown":"\n\nThis document aims at introducing SINAN malaria data to someone with no previous experience.\n\nThe steps include:\n\n0.  Downloading the data\n1.  Getting to know the data: variables and completeness\n2.  Information on the patients: Age, Sex, Pregnancy and Race\n3.  Classifying the malaria cases: detection and symptoms\n4.  Timeline of malaria cases: distribution throughout the year, and course of the cases\n5.  Mapping spatially: municipality types, malaria types and incidences\n\nAlong the way, each topic will be divided into 3:\n\n-   ![](images/idea-02.png){width=\"25\"} indicates that you will learn something\n\n-   ![](images/eye-01.png){width=\"24\"} indicates that you will see the data in a plot\n\n-   ![](images/filter-01.png){width=\"20\"} indicates that there is a opportunity to filter data (if necessary).\n\n\n![](images/idea-02.png){width=\"25\"} In every R script,\n\nIn this script we will need the following R-scripts:\n\n-   microdatasus: To download the health data from brazil\n\n-   dplyr:\n\n-   purrr:\n\n-   ggplot2: to create the graphs\n\n-   tidyr:\n\n-   lubridate: to help format the dates\n\n-   geobr: to download the shapefiles of brazils\n\n-   stringr:\n\nOther options that are being set up now include, setting a maximum waiting time for functions (i.e. timeout), how large number should be displayed (i.e. scipen) and functions are locally loaded.\n\n```{r message=FALSE, warning=FALSE}\n# load packages\npackages  <- c(\"microdatasus\", \"dplyr\", \"purrr\", \"ggplot2\",\"tidyr\", \n               \"lubridate\",\"geobr\", \"stringr\")\ninvisible(install.packages(setdiff(packages, rownames(installed.packages()))))\ninvisible(lapply(packages, function(pkg) suppressMessages(require(pkg, character.only = TRUE))))\n\n# other options\noptions(scipen = 999)\noptions(timeout = 900)\n\n# load functions\nfiles.sources <-  list.files(\"R/\")\ninvisible(sapply(paste0(\"R/\", files.sources), source))\n```\n\n# Downloading the data\n\nAs described in the [download data - instructions](brazil_download_data.qmd), the health data from Brazil can be downloaded in many different ways. Here, it is downloaded with the help of the package *microdatasus*. The following code block will download the data for the year 2014 (which was chosen randomly).\n\n```{r Malaria_LoadData, message = FALSE, warning = FALSE}\n# malariaData <- fetch_datasus(year_start = 2014, year_end = 2014, information_system = \"SINAN-MALARIA\")\nmalariaData <- readRDS(\"data/mal14.rds\")\n```\n\n# Getting to know the Data\n\n### *Variables*\n\n![](images/idea-02.png){width=\"25\"} There are a total of `r length(malariaData)` variables. The variables names can be seen below:\n\n```{r Malaria_ColumnNames}\ncolnames(malariaData)\n```\n\nThe definition of each variable can be found in the [official documentation](workspace/Dictionary_Malaria_PT.pdf) or [online](http://portalsinan.saude.gov.br/images/documentos/Agravos/Malaria/DIC_DADOS_Malaria_v5.pdf) in Portuguese, or in this [translated csv file](workspace/Dictionary_Malaria_EN.csv). This file also contains the decodification for all numerical categories. A small overview of this file can be seen below:\n\n```{r Malaria_Dictionary, message = FALSE, warning = FALSE}\nmalariaVarDefPath <- file.path(getwd(), 'workspace', 'Dictionary_Malaria_EN.csv')\nmalariaVarDef <- read.csv(malariaVarDefPath)\nknitr::kable(malariaVarDef[14:20,1:5])\n```\n\n![](images/filter-01.png){width=\"20\"} To avoid working with unnecessary data, it is useful to filter out the variables that will not be used. Below is a line of code on how to select only the needed variables.\n\n```{r Malaria_SelectVariables}\nsel_var <- c(\"NU_IDADE_N\",\"CS_SEXO\", \"CS_GESTANT\", \"CS_RACA\", \"AT_LAMINA\", \"AT_SINTOMA\", \"DT_NOTIFIC\", \"DT_SIN_PRI\", \"DT_DIGITA\", \"DEXAME\", \"DTRATA\", \"ID_MUNICIP\",  \"ID_MN_RESI\",  \"COMUNINF\",\"RESULT\") \n\nmalariaData <- malariaData %>% select(all_of(sel_var))\n```\n\n### *Completeness of the data*\n\n![](images/idea-02.png){width=\"25\"} Some of these variables are mandatory to notify, others are not, which leads to incomplete datasets. The chart **NACountChart** shows the the variables which have NA-values and the percentage of NAs they contain.\n\n```{r Malaria_NAs}\nNACount <- malariaData %>% map(~mean(is.na(.)))\nNACount <- data.frame(count=unlist(NACount),\n                      var=names(NACount))\n\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_NAs_visualise}\nggplot(NACount[NACount$count != 0, ], aes(x = reorder(var, count), y = count)) +\n  geom_bar(stat = \"identity\", width = 0.9, position = position_dodge(width = 5)) +\n  ylab(\"Percentage of NAs in each column\") +\n  xlab(\"Variables\") +\n  coord_flip()\n```\n\nOn the contrary, it is also good to know what variables are complete.\n\n```{r Malaria_Complete}\nNACount$var[NACount$count == 0]\n```\n\n![](images/filter-01.png){width=\"20\"} To filter out variables which are (almost) completely empty,you can run the following lines.\n\n```{r Malaria_SelectVariables2}\ndrop_variables <- NACount$var[NACount$count == 1]\nmalariaData <- malariaData[, !(names(malariaData) %in% drop_variables)]\n```\n\n#### Exam results\n\n![](images/idea-02.png){width=\"25\"} The database distinguishes 10 different types/combinations of malaria:\n\n1.  Negative\n2.  *Falciparum*\n3.  *F+Fg*\n4.  *Vivax*\n5.  *F+V*\n6.  *V+Fg*\n7.  *Fg*\n8.  *Malariae*\n9.  *F+M* 10.*Ovale*\n\nThe **negative** notification needs to be filtered (excluded) to obtain the total malaria cases because they are not cases as the exam result was negative. Also, we should exclude NAs.\n\n```{r Malaria_Type_learn}\nmalariaData <- malariaData %>%\n  mutate(RESULT = as.factor(case_when(RESULT == \"1\" ~ \"Negative\",\n                                      RESULT == \"2\" ~ \"Falciparum\",\n                                      RESULT == \"3\" ~ \"F+Fg\",\n                                      RESULT == \"4\" ~ \"Vivax\",\n                                      RESULT == \"5\" ~ \"F+V\",\n                                      RESULT == \"6\" ~ \"V+Fg\",\n                                      RESULT == \"7\" ~ \"Fg\",\n                                      RESULT == \"8\" ~ \"Malariae\",\n                                      RESULT == \"9\" ~ \"F+M\",\n                                      RESULT == \"10\" ~ \"Ovale\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Type_visualise}\nggplot(malariaData, aes(x = RESULT, fill=RESULT)) +\n  geom_bar() +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$RESULT)), \" NA values\"))+\n  labs(title=\"Exam results during malaria cases in 2014\",\n       y=\"Count\", x=\"Exam Result\", fill=\"Exam Results\") +\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = RESULT))\n```\n\n![](images/idea-02.png){width=\"25\"} However, generally, people only distinguish in 3 categories: *P. vivax* and *P. falciparum* and the mixed version *P+V*.\n\n```{r}\nmalariaData <- malariaData %>%\n  mutate(RES_EXAM = as.factor(case_when(RESULT == \"Falciparum\" | RESULT == \"F+Fg\" | RESULT == \"Fg\" | RESULT == \"F+M\" ~ \"F\",\n                                        RESULT == \"Vivax\" | RESULT == \"V+Fg\" ~ \"V\",\n                                        RESULT == \"F+V\"  ~  \"V+F\",\n                                        RESULT == \"Malariae\" | RESULT == \"Ovale\" ~ \"other\",\n                                        RESULT == \"Negative\" ~ \"Negative\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r}\nggplot(malariaData, aes(x = RES_EXAM, fill=RES_EXAM)) +\n  geom_bar() +\n  labs(title=\"Exam results during malaria cases in 2014\",\n       y=\"Count\", x=\"Exam Result\", fill=\"Exam Results\") +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$RES_EXAM)), \" NA values\"))+\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = RES_EXAM))\n```\n\nThe majority of case are *Vivax* (`r round(count(malariaData[malariaData$RESULT == 4,])/nrow(malariaData)*100, digits=1)`%), followed by *Falciparum* (`r round(count(malariaData[malariaData$RESULT == 2,])/nrow(malariaData)*100, digits=1)`%). All other categories together make `r round(count(malariaData[malariaData$RESULT != 2 & malariaData$RESULT != 4 ,])/nrow(malariaData)*100, digits=1)`%. Fg is the gametocyte phase of the *P. falciparum* life cycle.\n\nBelow, the distribution of the most prevalent malaria can bee seen throughout the year on an epiweek time resolution. Note the *vivax* and *falciparum* cases are the combination between more than one **RESULT** category.\n\n```{r Malaria_TypeTimeseries, echo=FALSE}\nmalariaData %>%\n  mutate(epiweek = paste0(sprintf(\"%02d\",epiweek(DT_NOTIFIC)))) %>%\n  group_by(epiweek,RES_EXAM) %>%\n  summarise(Count = n(), .groups = 'drop')%>%\n  pivot_wider(., id_cols = epiweek, names_from = RES_EXAM, values_from = Count) %>%\n  mutate(across(everything(), ~ replace_na(., 0)))%>%\n  ggplot(aes(x = epiweek)) +\n  labs(title=\"Malaria notification in 2014 per type of Malaria\",\n       y=\"Number of cases\", x=\"Week of the year\", color = 'Malaria type') +\n  geom_line(aes(y = V, group = 1, color = \"P.vivax\")) +\n  geom_line(aes(y = F, group = 1, color = \"P.falciparum\")) +\n  geom_line(aes(y = `V+F`, group = 1, color = \"Mixed malaria\")) +\n  geom_line(aes(y = `other`, group = 1, color = \"Other malaria\"))\n```\n\n![](images/filter-01.png){width=\"20\"} To exclude cases with a negative test result, you can run the following lines\n\n```{r Filtering negative notification}\nmalariaData <- malariaData[malariaData$RESULT != \"Negative\",]\n```\n\n# Information on the Patients\n\n### *Age of patients*\n\n![](images/idea-02.png){width=\"25\"} For malaria, the age of the patients can be derived from **NU_IDADE_N**. **NU_IDADE_N** is codified:\n\n-   the first number indicates what \"dimension\" it is using. 1= Hour, 2= day, 3= month, 4= year.\n-   the last numbers indicate the age.\n\nThe age can be \"decodified\" with the command line below. This line of code also automatically removes all inconsistent ages, i.e. people over 120 years and people whose age was given in a unusual way (e.g. 84 months).\n\n```{r Malaria_Age_learn, warning=FALSE}\nmalariaData  <- malariaData %>%\n  mutate(AGE = case_when(NU_IDADE_N < 120 ~ as.numeric(NU_IDADE_N), # assumes that non-codified data means that the age in years was given\n                           NU_IDADE_N >= 120 & NU_IDADE_N < 1000 ~ NA_real_,\n                           NU_IDADE_N >= 1000 & NU_IDADE_N < 2366 ~ 0,\n                           NU_IDADE_N >= 2366 & NU_IDADE_N < 3000 ~ NA_real_,\n                           NU_IDADE_N >= 3000 & NU_IDADE_N < 3013 ~ 0,\n                           NU_IDADE_N >= 3013 & NU_IDADE_N < 4000 ~ NA_real_,\n                           NU_IDADE_N >= 4000 & NU_IDADE_N < 4120 ~ as.numeric(NU_IDADE_N - 4000),\n                           NU_IDADE_N >= 4120 ~ NA_real_,\n                           TRUE ~ NA_real_))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Age_visualise, warning=FALSE}\nggplot(malariaData, aes(x = AGE))+\n  geom_histogram(binwidth = 1, fill = \"lightblue\",color=\"black\", alpha = 0.7)+\n  annotate(\"text\", x = 100, y = Inf, label = paste0(sum(is.na(malariaData$AGE)), \" NA values\"), hjust = 1, vjust = 1, size = 4)+\n  labs(x=\"Age [years]\", y=\"Count\", title=\"Age distribution\")+\n  theme_light()\n\n```\n\n![](images/filter-01.png){width=\"20\"} Other datasets may include a date of birth, if provided, it can be used to corroborate the real age.\n\n### *Sex of the patients*\n\n![](images/idea-02.png){width=\"25\"} The sex of the patients is given by **CS_SEXO**. A table and a barplot of its distribution can be seen below:\n\n```{r Malaria_Sex_learn}\nmalariaData <- malariaData %>%\n  mutate(CS_SEXO = as.factor(case_when(CS_SEXO == \"F\" ~ \"Female\",\n                                       CS_SEXO == \"M\" ~ \"Male\",\n                                       CS_SEXO == \"I\" ~ \"Ignored\",\n                                       TRUE ~ \"NA\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Sex plot}\n ggplot(malariaData, aes(x = CS_SEXO, fill=CS_SEXO)) +\n  geom_bar() +\n  labs(title=\"Sex distribution of malaria cases in 2015\",\n       x=\"Sex of the patient\", y=\"Count\", fill=\"Sex\")+\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = CS_SEXO)) +\n  theme_light()\n```\n\n### *Pregnancy*\n\n![](images/idea-02.png){width=\"25\"} Another related variable is **CS_GESTANT**, which indicates whether the patient is pregnant. Since only women below a certain age can get pregnant this is another way to check for inconsistencies.\n\n```{r malaria_Pregnancy}\npregnant <- malariaData %>%\n  filter((CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\nmpreg <- malariaData %>%\n  filter(CS_SEXO == \"M\" & (CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\npover50 <- malariaData %>%\n  filter(AGE > 50 & (CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\n```\n\n![](images/filter-01.png){width=\"20\"} Out of `r pregnant` pregnant patients, there are `r mpreg` pregnant males and `r pover50` pregnant women over the age of 50. Again, depending on the aim of the study, these patients could be excluded using the following line.\n\n```{r Malaria_SexFilter}\nmalariaData <- malariaData %>%\n  filter(!(CS_GESTANT %in% c(\"1\", \"2\", \"3\", \"4\") & CS_SEXO == \"M\") & \n           !(CS_GESTANT %in% c(\"1\", \"2\", \"3\", \"4\") & AGE > 50))\n```\n\n### *Race of the patients*\n\n![](images/idea-02.png){width=\"25\"} The race of the patient is given by **CS_RACA**. A barplot of its distribution can be seen below:\n\n```{r Malaria_Race_learn}\nmalariaData <- malariaData %>%\n    mutate(CS_RACA = as.factor(case_when(CS_RACA == 1 ~ \"White\",\n                                       CS_RACA == 2 ~ \"Black\",\n                                       CS_RACA == 3 ~ \"Yellow\",\n                                       CS_RACA == 4 ~ \"Brown\",\n                                       CS_RACA == 5 ~ \"Indigenous\",\n                                       CS_RACA == 9 ~ \"Ignored\",\n                                       TRUE ~ \"NA\")))\n\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Race_visualise, echo=FALSE}\nggplot(malariaData, aes(x = CS_RACA, fill=CS_RACA)) +\n  geom_bar(stat = \"count\") +\n  labs(title=\"Race distribution of malaria cases in 2015\",\n       x=\"Race of the patient\", y=\"Count\", fill=\"Race\") +\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = CS_RACA),\n            position = position_stack(vjust = 0.5)) +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$CS_RACA)), \" NA values\"))\n\n```\n\n# Classifying the malaria cases\n\n### *Type of detection*\n\n![](images/idea-02.png){width=\"25\"} Malaria can be detected either actively (when someone goes to doctor because of symptoms), passively (as protocol when one case is detected, people living in the same place are screened) or through LVC (Lamina de Verificaçao de Cura = cure thick blood smear verification). The variable **AT_LAMINA**, shows exactly this.\n\n```{r Malaria_Detection_learn}\nmalariaData <- malariaData %>%\n    mutate(AT_LAMINA = as.factor(case_when(AT_LAMINA == 1 ~ \"Active\",\n                                       AT_LAMINA == 2 ~ \"Passive\",\n                                       AT_LAMINA == 3 ~ \"LVC\",\n                                       TRUE ~ \"NA\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Detection_visualise}\nggplot(malariaData, aes(x = AT_LAMINA, fill=AT_LAMINA)) +\n  geom_bar() +\n  labs(title=\"Type of detections of malaria cases in 2014\",\n       y=\"Count\", x=\"Detection type\", fill=\"Detection type\")+\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = AT_LAMINA),\n            position = position_stack(vjust = 0.5)) +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$AT_LAMINA)), \" NA values\"))\n```\n\nAs can be seen, most cases (`r round((table(malariaData$AT_LAMINA)[1]/nrow(malariaData))*100, digits=1)`%) are found actively and only `r round((table(malariaData$AT_LAMINA)[2]/nrow(malariaData))*100, digits=1)`% are passively.\n\n### *Symptoms*\n\n![](images/idea-02.png){width=\"25\"} For malaria, the variable **AT_SINTOMA** makes the distinction whether there are symptoms present or not.\n\n```{r Malaria_Symptoms_learn}\nmalariaData <- malariaData %>%\n  mutate(AT_SINTOMA = as.factor(case_when(AT_SINTOMA== \"1\" ~ \"Yes\",\n                                          AT_SINTOMA == \"2\" ~ \"No\",\n                                          TRUE ~ \"NA\")))\n\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Symptoms_visualise}\nggplot(data= malariaData, aes(x = AT_SINTOMA, fill=AT_SINTOMA)) +\n  geom_bar() +\n  labs(title=\"Presence of symptoms during malaria cases in 2014\",\n       y=\"Count\", x=\"Presence of symptoms\", fill=\"Presence of symptoms\") +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$AT_SINTOMA)), \" NA values\"))+\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = AT_SINTOMA))\n```\n\nA clear majority of `r round((table(malariaData$SINTOMAS)[1]/nrow(malariaData))*100, digits=1)`% malaria cases had symptoms.\n\n# Timeline of malaria cases\n\n### *Notification distribution throughout the year*\n\n![](images/idea-02.png){width=\"25\"} In the dataset, you can find many dates, one of the most important might be the notification date **DT_NOTIFIC**. This is the first time that a potential malaria patient contacts the medical authorities. Below the annual distribution of notifications during 2014 can be seen. There is no clear seasonal variation but tended to concentrate cases during the summer season in Brazil.\n\n```{r warning=FALSE}\nmalariaData %>%\n  mutate(EPIWEEK = floor_date(DT_NOTIFIC, \"weeks\")) %>%\n  group_by(EPIWEEK) %>%\n  summarise(Count = n()) %>%\n  ggplot() +\n  geom_line(aes(x = EPIWEEK, y = Count)) +\n  scale_x_date(date_labels = \"%m-%d\", date_breaks = \"1 week\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n### *Timeline of all other events*\n\n![](images/idea-02.png){width=\"25\"} First, symptoms occur (**DT_SIN_TO_PRI**). Once the doctor notifies a suspected malaria case (**DT_NOTIFIC**), it will be digitized (**DT_DIGITA**). The malaria case needs to be confirmed through an exam (**DEXAME**), and if confirmed, treated (**DTRATA**). Below are boxplots for each of the events date.\n\n```{r Malaria_Timeline, warning = FALSE}\nmalariaData <- malariaData %>%\n  mutate(Symptoms = as.numeric(DT_SIN_PRI - DT_NOTIFIC),\n         Digitalization = as.numeric(DT_DIGITA - DT_NOTIFIC),\n         Exam = as.numeric(DEXAME - DT_NOTIFIC),\n         Treatment = as.numeric(DTRATA - DT_NOTIFIC))\n\n```\n\n```{r Malaria_Timeline_visualise, warning = FALSE}\nmalariaData %>%\n  select(Symptoms, Digitalization, Exam, Treatment) %>%\n  gather(TYPE, DAYS) %>%\n  ggplot(aes(x = TYPE, y = DAYS)) +\n  geom_boxplot() +\n  coord_cartesian(ylim = c(-100, 100)) +\n  xlab(\"Event\") +\n  ylab(\"Days from the notification day\")\n\n```\n\nThe boxplot is able to visualize possible outliers:\n\n-   The **first symptoms** occur before the notification date, the vast majority of them in the 10 days prior to it. Symptoms that occur after the notification date or a long time before hte notification date may have to be removed.\n-   The **treatment**, **digitalization** and **exam** dates, must fall on or within the 60 days after the notification date. If they fall outside this range, they can be coonsidered outliers and may be removed.\n\n# Mapping spatially\n\n### *Notification, Residence & Probable Infection*\n\n![](images/idea-02.png){width=\"25\"} There is of course also spatial data in the data sets. Before diving in deeper it is necessary to download the shapefiles of Brazil municipalities. This can be done via the *geobr* package. However, the municipality code given by geobr is one digit too long and has to be shortened to 6 digits.\n\nIn total, the dataset refers to 3 different locations:\n\n-   **ID_MUNICIP** is the municipality where the case is notified.\n-   **ID_MN_RESI** is the municipality of residence of the patient.\n-   **COMUNINF** is the municipality the patient probably got the infection.\n\n```{r Malaria_LoadMuni, message=FALSE, warning=FALSE}\n# muni <- read_municipality(code_muni = \"all\", year = 2014, showProgress = FALSE) %>%\n#   mutate(code_muni = str_sub(code_muni, end = 6)) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP, dnn = list(\"code_muni\")), responseName = \"noti_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$COMUNINF, dnn = list(\"code_muni\")), responseName = \"infec_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MN_RESI, dnn = list(\"code_muni\")), responseName = \"resi_muni\"))\n```\n\nDepending on what the aim of the study is, each of these variables can be important.\n\n```{r Malaria_plot, message = FALSE, warning = FALSE}\n# cols <- c(\"green\", \"yellow\",\"orange\",\"red\", \"black\") #change these as needed\n# breaks <- c(0, 10, 100, 1000, 10000, 100000) #change these as needed\n# \n# ggplot(muni) +\n#   ggtitle(\"Extra-Amazon malaria per municipality of notification\") +\n#   geom_sf( aes(fill = noti_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_stepsn(breaks = breaks,\n#                     colours = cols,\n#                     values = scales::rescale(breaks))\n# \n# ggplot(muni) +\n#   ggtitle(\"Extra-Amazon malaria per municipality of probable infection\") +\n#   geom_sf(aes(fill = infec_muni), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks,\n#                     colours = cols,\n#                     values = scales::rescale(breaks))\n# \n# ggplot(muni) +\n#   ggtitle(\"Extra-Amazon malaria per municipality of residence\")+\n#   geom_sf( aes(fill = resi_muni), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks,\n#                     colours = cols,\n#                     values = scales::rescale(breaks))\n```\n\n**What did you find after see the maps?** Take a look of the difference between the Extra-Amazon malaria by municipality of notification and probable infection. Almost all malaria notified in the Extra-Amazon region was acquired in the Amazon region. Some people live in the Amazon region were notified in the Extra-Amazon region.\n\n### *Mapping types of Malaria*\n\nIf one wants to map them distinguishing by type, the following code can be used:\n\n```{r Malaria_plotType, message = FALSE, warning = FALSE}\n# muni <- muni %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"V\"], dnn = list(\"code_muni\")), responseName = \"vivax_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"F\"], dnn = list(\"code_muni\")), responseName = \"falci_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"V+F\"], dnn = list(\"code_muni\")), responseName = \"mixed_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"other\"], dnn = list(\"code_muni\")), responseName = \"other_muni\"))\n# \n# vivax_plot <- ggplot(muni) +\n#   geom_sf( aes(fill = vivax_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle = paste0(\"Number of P. vivax cases in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# vivax_plot\n# \n# falci_plot <-  ggplot(muni) +\n#   geom_sf( aes(fill = falci_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle=paste0(\"Number of P. falciparum cases in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# falci_plot\n# \n# mixed_plot <-  ggplot(muni) +\n#   geom_sf( aes(fill = mixed_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle=paste0(\"Number of mixed cases in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# mixed_plot\n```\n\n### *Calculating the incidence*\n\nSometimes, having the absolute values is helpful. But other times, the number of cases can be highly dependent on the number of inhabitants and then the incidence or other similar indicator is used. Another reason to use incidence is to make comparable the number of cases between areas and different times. Specifically for malaria, the analogous indicator, the Annual Parasite Index (API) is most common. This indicator is calculated by the number of malaria positive patients occurred in a specific time and place divided by the population per 1.000 inhabitants. This positive patients can be a new case or a relapse. Relapses are most common in malaria *vivax* infection.\n\nFor this, the population data needs to be loaded from [IBGE](https://www.ibge.gov.br/estatisticas/sociais/populacao/9103-estimativas-de-populacao.html?edicao=31451&t=resultados) either manually or using the local function \"get_br_pop_data\" (instructions can be viewed in 0_DownloadData.md).\n\n```{r Malaria_LoadPopulation, message = FALSE}\n# get_br_pop_data(2015, save=F)\n# \n# muni <-  left_join(muni, pop_2015[c(\"code_muni\",\"pop\")], by=\"code_muni\")\n# muni$pop <- as.numeric(muni$pop)\n```\n\nThe incidence is then calculated by dividing the malaria cases by the population of each municipality and multiplication by 1000.\n\n```{r Malaria_Incidence, message = FALSE, warning = FALSE}\n# muni$noti_inc <- muni$noti_muni / muni$pop*1000\n# muni$infec_inc <- muni$infec_muni / muni$pop*1000\n# muni$resi_inc <- muni$resi_muni / muni$pop*1000\n# \n# breaks2 <- c(0, 5, 25, 50, 100, 250)\n# noti_inci_plot <- ggplot(muni) +\n#   ggtitle(\"Incidence of malaria notifications in 2015\")+\n#   geom_sf( aes(fill = noti_inc), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks2,\n#                     colours = cols,\n#                     values = scales::rescale(breaks2))\n# noti_inci_plot\n# \n# infe_inci_plot <- ggplot(muni) +\n#   ggtitle(\"Incidence of probable malaria infections in 2015\")+\n#   geom_sf(aes(fill = infec_inc), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks2,\n#                     colours = cols,\n#                     values = scales::rescale(breaks2))\n# infe_inci_plot\n# \n# resi_inci_plot <- ggplot(muni) +\n#   ggtitle(\"Incidence of residents with malaria in 2015\")+\n#   geom_sf(aes(fill = resi_inc), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks2,\n#                     colours = cols,\n#                     values = scales::rescale(breaks2))\n# resi_inci_plot\n```\n\nIf one wants to know the incidence depending on the malaria type:\n\n```{r Malaria_TypeIncidence}\n# muni$vivax_inc <- muni$vivax_muni / muni$pop*1000\n# muni$falci_inc <- muni$falci_muni / muni$pop*1000\n# muni$mixed_inc <- muni$mixed_muni / muni$pop*1000\n# \n# vivax_inci_plot <- ggplot(muni) +\n#   geom_sf(aes(fill = vivax_inc), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle = paste0(\"Vivax incidence in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# vivax_inci_plot\n# \n# falci_inci_plot<- ggplot(muni) +\n#   geom_sf( aes(fill = falci_inc), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c()+\n#   labs(subtitle = paste0(\"Falciparum incidence in Brazil in 2015\"), size = 8) +\n#   theme_minimal()\n# falci_inci_plot\n# \n# mixed_inci_plot<- ggplot(muni) +\n#   geom_sf( aes(fill = mixed_inc), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c()+\n#   labs(subtitle = paste0(\"Mixed incidence in Brazil in 2015\"), size = 8) +\n#   theme_minimal()\n# mixed_inci_plot\n```\n","srcMarkdownNoYaml":"\n\nThis document aims at introducing SINAN malaria data to someone with no previous experience.\n\nThe steps include:\n\n0.  Downloading the data\n1.  Getting to know the data: variables and completeness\n2.  Information on the patients: Age, Sex, Pregnancy and Race\n3.  Classifying the malaria cases: detection and symptoms\n4.  Timeline of malaria cases: distribution throughout the year, and course of the cases\n5.  Mapping spatially: municipality types, malaria types and incidences\n\nAlong the way, each topic will be divided into 3:\n\n-   ![](images/idea-02.png){width=\"25\"} indicates that you will learn something\n\n-   ![](images/eye-01.png){width=\"24\"} indicates that you will see the data in a plot\n\n-   ![](images/filter-01.png){width=\"20\"} indicates that there is a opportunity to filter data (if necessary).\n\n# Setting up the R environment\n\n![](images/idea-02.png){width=\"25\"} In every R script,\n\nIn this script we will need the following R-scripts:\n\n-   microdatasus: To download the health data from brazil\n\n-   dplyr:\n\n-   purrr:\n\n-   ggplot2: to create the graphs\n\n-   tidyr:\n\n-   lubridate: to help format the dates\n\n-   geobr: to download the shapefiles of brazils\n\n-   stringr:\n\nOther options that are being set up now include, setting a maximum waiting time for functions (i.e. timeout), how large number should be displayed (i.e. scipen) and functions are locally loaded.\n\n```{r message=FALSE, warning=FALSE}\n# load packages\npackages  <- c(\"microdatasus\", \"dplyr\", \"purrr\", \"ggplot2\",\"tidyr\", \n               \"lubridate\",\"geobr\", \"stringr\")\ninvisible(install.packages(setdiff(packages, rownames(installed.packages()))))\ninvisible(lapply(packages, function(pkg) suppressMessages(require(pkg, character.only = TRUE))))\n\n# other options\noptions(scipen = 999)\noptions(timeout = 900)\n\n# load functions\nfiles.sources <-  list.files(\"R/\")\ninvisible(sapply(paste0(\"R/\", files.sources), source))\n```\n\n# Downloading the data\n\nAs described in the [download data - instructions](brazil_download_data.qmd), the health data from Brazil can be downloaded in many different ways. Here, it is downloaded with the help of the package *microdatasus*. The following code block will download the data for the year 2014 (which was chosen randomly).\n\n```{r Malaria_LoadData, message = FALSE, warning = FALSE}\n# malariaData <- fetch_datasus(year_start = 2014, year_end = 2014, information_system = \"SINAN-MALARIA\")\nmalariaData <- readRDS(\"data/mal14.rds\")\n```\n\n# Getting to know the Data\n\n### *Variables*\n\n![](images/idea-02.png){width=\"25\"} There are a total of `r length(malariaData)` variables. The variables names can be seen below:\n\n```{r Malaria_ColumnNames}\ncolnames(malariaData)\n```\n\nThe definition of each variable can be found in the [official documentation](workspace/Dictionary_Malaria_PT.pdf) or [online](http://portalsinan.saude.gov.br/images/documentos/Agravos/Malaria/DIC_DADOS_Malaria_v5.pdf) in Portuguese, or in this [translated csv file](workspace/Dictionary_Malaria_EN.csv). This file also contains the decodification for all numerical categories. A small overview of this file can be seen below:\n\n```{r Malaria_Dictionary, message = FALSE, warning = FALSE}\nmalariaVarDefPath <- file.path(getwd(), 'workspace', 'Dictionary_Malaria_EN.csv')\nmalariaVarDef <- read.csv(malariaVarDefPath)\nknitr::kable(malariaVarDef[14:20,1:5])\n```\n\n![](images/filter-01.png){width=\"20\"} To avoid working with unnecessary data, it is useful to filter out the variables that will not be used. Below is a line of code on how to select only the needed variables.\n\n```{r Malaria_SelectVariables}\nsel_var <- c(\"NU_IDADE_N\",\"CS_SEXO\", \"CS_GESTANT\", \"CS_RACA\", \"AT_LAMINA\", \"AT_SINTOMA\", \"DT_NOTIFIC\", \"DT_SIN_PRI\", \"DT_DIGITA\", \"DEXAME\", \"DTRATA\", \"ID_MUNICIP\",  \"ID_MN_RESI\",  \"COMUNINF\",\"RESULT\") \n\nmalariaData <- malariaData %>% select(all_of(sel_var))\n```\n\n### *Completeness of the data*\n\n![](images/idea-02.png){width=\"25\"} Some of these variables are mandatory to notify, others are not, which leads to incomplete datasets. The chart **NACountChart** shows the the variables which have NA-values and the percentage of NAs they contain.\n\n```{r Malaria_NAs}\nNACount <- malariaData %>% map(~mean(is.na(.)))\nNACount <- data.frame(count=unlist(NACount),\n                      var=names(NACount))\n\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_NAs_visualise}\nggplot(NACount[NACount$count != 0, ], aes(x = reorder(var, count), y = count)) +\n  geom_bar(stat = \"identity\", width = 0.9, position = position_dodge(width = 5)) +\n  ylab(\"Percentage of NAs in each column\") +\n  xlab(\"Variables\") +\n  coord_flip()\n```\n\nOn the contrary, it is also good to know what variables are complete.\n\n```{r Malaria_Complete}\nNACount$var[NACount$count == 0]\n```\n\n![](images/filter-01.png){width=\"20\"} To filter out variables which are (almost) completely empty,you can run the following lines.\n\n```{r Malaria_SelectVariables2}\ndrop_variables <- NACount$var[NACount$count == 1]\nmalariaData <- malariaData[, !(names(malariaData) %in% drop_variables)]\n```\n\n#### Exam results\n\n![](images/idea-02.png){width=\"25\"} The database distinguishes 10 different types/combinations of malaria:\n\n1.  Negative\n2.  *Falciparum*\n3.  *F+Fg*\n4.  *Vivax*\n5.  *F+V*\n6.  *V+Fg*\n7.  *Fg*\n8.  *Malariae*\n9.  *F+M* 10.*Ovale*\n\nThe **negative** notification needs to be filtered (excluded) to obtain the total malaria cases because they are not cases as the exam result was negative. Also, we should exclude NAs.\n\n```{r Malaria_Type_learn}\nmalariaData <- malariaData %>%\n  mutate(RESULT = as.factor(case_when(RESULT == \"1\" ~ \"Negative\",\n                                      RESULT == \"2\" ~ \"Falciparum\",\n                                      RESULT == \"3\" ~ \"F+Fg\",\n                                      RESULT == \"4\" ~ \"Vivax\",\n                                      RESULT == \"5\" ~ \"F+V\",\n                                      RESULT == \"6\" ~ \"V+Fg\",\n                                      RESULT == \"7\" ~ \"Fg\",\n                                      RESULT == \"8\" ~ \"Malariae\",\n                                      RESULT == \"9\" ~ \"F+M\",\n                                      RESULT == \"10\" ~ \"Ovale\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Type_visualise}\nggplot(malariaData, aes(x = RESULT, fill=RESULT)) +\n  geom_bar() +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$RESULT)), \" NA values\"))+\n  labs(title=\"Exam results during malaria cases in 2014\",\n       y=\"Count\", x=\"Exam Result\", fill=\"Exam Results\") +\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = RESULT))\n```\n\n![](images/idea-02.png){width=\"25\"} However, generally, people only distinguish in 3 categories: *P. vivax* and *P. falciparum* and the mixed version *P+V*.\n\n```{r}\nmalariaData <- malariaData %>%\n  mutate(RES_EXAM = as.factor(case_when(RESULT == \"Falciparum\" | RESULT == \"F+Fg\" | RESULT == \"Fg\" | RESULT == \"F+M\" ~ \"F\",\n                                        RESULT == \"Vivax\" | RESULT == \"V+Fg\" ~ \"V\",\n                                        RESULT == \"F+V\"  ~  \"V+F\",\n                                        RESULT == \"Malariae\" | RESULT == \"Ovale\" ~ \"other\",\n                                        RESULT == \"Negative\" ~ \"Negative\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r}\nggplot(malariaData, aes(x = RES_EXAM, fill=RES_EXAM)) +\n  geom_bar() +\n  labs(title=\"Exam results during malaria cases in 2014\",\n       y=\"Count\", x=\"Exam Result\", fill=\"Exam Results\") +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$RES_EXAM)), \" NA values\"))+\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = RES_EXAM))\n```\n\nThe majority of case are *Vivax* (`r round(count(malariaData[malariaData$RESULT == 4,])/nrow(malariaData)*100, digits=1)`%), followed by *Falciparum* (`r round(count(malariaData[malariaData$RESULT == 2,])/nrow(malariaData)*100, digits=1)`%). All other categories together make `r round(count(malariaData[malariaData$RESULT != 2 & malariaData$RESULT != 4 ,])/nrow(malariaData)*100, digits=1)`%. Fg is the gametocyte phase of the *P. falciparum* life cycle.\n\nBelow, the distribution of the most prevalent malaria can bee seen throughout the year on an epiweek time resolution. Note the *vivax* and *falciparum* cases are the combination between more than one **RESULT** category.\n\n```{r Malaria_TypeTimeseries, echo=FALSE}\nmalariaData %>%\n  mutate(epiweek = paste0(sprintf(\"%02d\",epiweek(DT_NOTIFIC)))) %>%\n  group_by(epiweek,RES_EXAM) %>%\n  summarise(Count = n(), .groups = 'drop')%>%\n  pivot_wider(., id_cols = epiweek, names_from = RES_EXAM, values_from = Count) %>%\n  mutate(across(everything(), ~ replace_na(., 0)))%>%\n  ggplot(aes(x = epiweek)) +\n  labs(title=\"Malaria notification in 2014 per type of Malaria\",\n       y=\"Number of cases\", x=\"Week of the year\", color = 'Malaria type') +\n  geom_line(aes(y = V, group = 1, color = \"P.vivax\")) +\n  geom_line(aes(y = F, group = 1, color = \"P.falciparum\")) +\n  geom_line(aes(y = `V+F`, group = 1, color = \"Mixed malaria\")) +\n  geom_line(aes(y = `other`, group = 1, color = \"Other malaria\"))\n```\n\n![](images/filter-01.png){width=\"20\"} To exclude cases with a negative test result, you can run the following lines\n\n```{r Filtering negative notification}\nmalariaData <- malariaData[malariaData$RESULT != \"Negative\",]\n```\n\n# Information on the Patients\n\n### *Age of patients*\n\n![](images/idea-02.png){width=\"25\"} For malaria, the age of the patients can be derived from **NU_IDADE_N**. **NU_IDADE_N** is codified:\n\n-   the first number indicates what \"dimension\" it is using. 1= Hour, 2= day, 3= month, 4= year.\n-   the last numbers indicate the age.\n\nThe age can be \"decodified\" with the command line below. This line of code also automatically removes all inconsistent ages, i.e. people over 120 years and people whose age was given in a unusual way (e.g. 84 months).\n\n```{r Malaria_Age_learn, warning=FALSE}\nmalariaData  <- malariaData %>%\n  mutate(AGE = case_when(NU_IDADE_N < 120 ~ as.numeric(NU_IDADE_N), # assumes that non-codified data means that the age in years was given\n                           NU_IDADE_N >= 120 & NU_IDADE_N < 1000 ~ NA_real_,\n                           NU_IDADE_N >= 1000 & NU_IDADE_N < 2366 ~ 0,\n                           NU_IDADE_N >= 2366 & NU_IDADE_N < 3000 ~ NA_real_,\n                           NU_IDADE_N >= 3000 & NU_IDADE_N < 3013 ~ 0,\n                           NU_IDADE_N >= 3013 & NU_IDADE_N < 4000 ~ NA_real_,\n                           NU_IDADE_N >= 4000 & NU_IDADE_N < 4120 ~ as.numeric(NU_IDADE_N - 4000),\n                           NU_IDADE_N >= 4120 ~ NA_real_,\n                           TRUE ~ NA_real_))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Age_visualise, warning=FALSE}\nggplot(malariaData, aes(x = AGE))+\n  geom_histogram(binwidth = 1, fill = \"lightblue\",color=\"black\", alpha = 0.7)+\n  annotate(\"text\", x = 100, y = Inf, label = paste0(sum(is.na(malariaData$AGE)), \" NA values\"), hjust = 1, vjust = 1, size = 4)+\n  labs(x=\"Age [years]\", y=\"Count\", title=\"Age distribution\")+\n  theme_light()\n\n```\n\n![](images/filter-01.png){width=\"20\"} Other datasets may include a date of birth, if provided, it can be used to corroborate the real age.\n\n### *Sex of the patients*\n\n![](images/idea-02.png){width=\"25\"} The sex of the patients is given by **CS_SEXO**. A table and a barplot of its distribution can be seen below:\n\n```{r Malaria_Sex_learn}\nmalariaData <- malariaData %>%\n  mutate(CS_SEXO = as.factor(case_when(CS_SEXO == \"F\" ~ \"Female\",\n                                       CS_SEXO == \"M\" ~ \"Male\",\n                                       CS_SEXO == \"I\" ~ \"Ignored\",\n                                       TRUE ~ \"NA\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Sex plot}\n ggplot(malariaData, aes(x = CS_SEXO, fill=CS_SEXO)) +\n  geom_bar() +\n  labs(title=\"Sex distribution of malaria cases in 2015\",\n       x=\"Sex of the patient\", y=\"Count\", fill=\"Sex\")+\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = CS_SEXO)) +\n  theme_light()\n```\n\n### *Pregnancy*\n\n![](images/idea-02.png){width=\"25\"} Another related variable is **CS_GESTANT**, which indicates whether the patient is pregnant. Since only women below a certain age can get pregnant this is another way to check for inconsistencies.\n\n```{r malaria_Pregnancy}\npregnant <- malariaData %>%\n  filter((CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\nmpreg <- malariaData %>%\n  filter(CS_SEXO == \"M\" & (CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\npover50 <- malariaData %>%\n  filter(AGE > 50 & (CS_GESTANT == 1 | CS_GESTANT == 2 | CS_GESTANT ==3 | CS_GESTANT == 4)) %>%\n  count()\n\n```\n\n![](images/filter-01.png){width=\"20\"} Out of `r pregnant` pregnant patients, there are `r mpreg` pregnant males and `r pover50` pregnant women over the age of 50. Again, depending on the aim of the study, these patients could be excluded using the following line.\n\n```{r Malaria_SexFilter}\nmalariaData <- malariaData %>%\n  filter(!(CS_GESTANT %in% c(\"1\", \"2\", \"3\", \"4\") & CS_SEXO == \"M\") & \n           !(CS_GESTANT %in% c(\"1\", \"2\", \"3\", \"4\") & AGE > 50))\n```\n\n### *Race of the patients*\n\n![](images/idea-02.png){width=\"25\"} The race of the patient is given by **CS_RACA**. A barplot of its distribution can be seen below:\n\n```{r Malaria_Race_learn}\nmalariaData <- malariaData %>%\n    mutate(CS_RACA = as.factor(case_when(CS_RACA == 1 ~ \"White\",\n                                       CS_RACA == 2 ~ \"Black\",\n                                       CS_RACA == 3 ~ \"Yellow\",\n                                       CS_RACA == 4 ~ \"Brown\",\n                                       CS_RACA == 5 ~ \"Indigenous\",\n                                       CS_RACA == 9 ~ \"Ignored\",\n                                       TRUE ~ \"NA\")))\n\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Race_visualise, echo=FALSE}\nggplot(malariaData, aes(x = CS_RACA, fill=CS_RACA)) +\n  geom_bar(stat = \"count\") +\n  labs(title=\"Race distribution of malaria cases in 2015\",\n       x=\"Race of the patient\", y=\"Count\", fill=\"Race\") +\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = CS_RACA),\n            position = position_stack(vjust = 0.5)) +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$CS_RACA)), \" NA values\"))\n\n```\n\n# Classifying the malaria cases\n\n### *Type of detection*\n\n![](images/idea-02.png){width=\"25\"} Malaria can be detected either actively (when someone goes to doctor because of symptoms), passively (as protocol when one case is detected, people living in the same place are screened) or through LVC (Lamina de Verificaçao de Cura = cure thick blood smear verification). The variable **AT_LAMINA**, shows exactly this.\n\n```{r Malaria_Detection_learn}\nmalariaData <- malariaData %>%\n    mutate(AT_LAMINA = as.factor(case_when(AT_LAMINA == 1 ~ \"Active\",\n                                       AT_LAMINA == 2 ~ \"Passive\",\n                                       AT_LAMINA == 3 ~ \"LVC\",\n                                       TRUE ~ \"NA\")))\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Detection_visualise}\nggplot(malariaData, aes(x = AT_LAMINA, fill=AT_LAMINA)) +\n  geom_bar() +\n  labs(title=\"Type of detections of malaria cases in 2014\",\n       y=\"Count\", x=\"Detection type\", fill=\"Detection type\")+\n  geom_text(stat = 'count',\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = AT_LAMINA),\n            position = position_stack(vjust = 0.5)) +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$AT_LAMINA)), \" NA values\"))\n```\n\nAs can be seen, most cases (`r round((table(malariaData$AT_LAMINA)[1]/nrow(malariaData))*100, digits=1)`%) are found actively and only `r round((table(malariaData$AT_LAMINA)[2]/nrow(malariaData))*100, digits=1)`% are passively.\n\n### *Symptoms*\n\n![](images/idea-02.png){width=\"25\"} For malaria, the variable **AT_SINTOMA** makes the distinction whether there are symptoms present or not.\n\n```{r Malaria_Symptoms_learn}\nmalariaData <- malariaData %>%\n  mutate(AT_SINTOMA = as.factor(case_when(AT_SINTOMA== \"1\" ~ \"Yes\",\n                                          AT_SINTOMA == \"2\" ~ \"No\",\n                                          TRUE ~ \"NA\")))\n\n```\n\n![](images/eye-01.png){width=\"24\"} Visualise it!\n\n```{r Malaria_Symptoms_visualise}\nggplot(data= malariaData, aes(x = AT_SINTOMA, fill=AT_SINTOMA)) +\n  geom_bar() +\n  labs(title=\"Presence of symptoms during malaria cases in 2014\",\n       y=\"Count\", x=\"Presence of symptoms\", fill=\"Presence of symptoms\") +\n  annotate(\"text\", x = Inf, y = Inf, hjust = 1, vjust = 1, size = 4,\n           label = paste0(sum(is.na(malariaData$AT_SINTOMA)), \" NA values\"))+\n  geom_text(stat = 'count', position = position_stack(vjust = 0.5),\n            aes(label = paste0(round((after_stat(count))/sum(after_stat(count)) * 100, 1), \"%\"),\n                x = AT_SINTOMA))\n```\n\nA clear majority of `r round((table(malariaData$SINTOMAS)[1]/nrow(malariaData))*100, digits=1)`% malaria cases had symptoms.\n\n# Timeline of malaria cases\n\n### *Notification distribution throughout the year*\n\n![](images/idea-02.png){width=\"25\"} In the dataset, you can find many dates, one of the most important might be the notification date **DT_NOTIFIC**. This is the first time that a potential malaria patient contacts the medical authorities. Below the annual distribution of notifications during 2014 can be seen. There is no clear seasonal variation but tended to concentrate cases during the summer season in Brazil.\n\n```{r warning=FALSE}\nmalariaData %>%\n  mutate(EPIWEEK = floor_date(DT_NOTIFIC, \"weeks\")) %>%\n  group_by(EPIWEEK) %>%\n  summarise(Count = n()) %>%\n  ggplot() +\n  geom_line(aes(x = EPIWEEK, y = Count)) +\n  scale_x_date(date_labels = \"%m-%d\", date_breaks = \"1 week\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1))\n```\n\n### *Timeline of all other events*\n\n![](images/idea-02.png){width=\"25\"} First, symptoms occur (**DT_SIN_TO_PRI**). Once the doctor notifies a suspected malaria case (**DT_NOTIFIC**), it will be digitized (**DT_DIGITA**). The malaria case needs to be confirmed through an exam (**DEXAME**), and if confirmed, treated (**DTRATA**). Below are boxplots for each of the events date.\n\n```{r Malaria_Timeline, warning = FALSE}\nmalariaData <- malariaData %>%\n  mutate(Symptoms = as.numeric(DT_SIN_PRI - DT_NOTIFIC),\n         Digitalization = as.numeric(DT_DIGITA - DT_NOTIFIC),\n         Exam = as.numeric(DEXAME - DT_NOTIFIC),\n         Treatment = as.numeric(DTRATA - DT_NOTIFIC))\n\n```\n\n```{r Malaria_Timeline_visualise, warning = FALSE}\nmalariaData %>%\n  select(Symptoms, Digitalization, Exam, Treatment) %>%\n  gather(TYPE, DAYS) %>%\n  ggplot(aes(x = TYPE, y = DAYS)) +\n  geom_boxplot() +\n  coord_cartesian(ylim = c(-100, 100)) +\n  xlab(\"Event\") +\n  ylab(\"Days from the notification day\")\n\n```\n\nThe boxplot is able to visualize possible outliers:\n\n-   The **first symptoms** occur before the notification date, the vast majority of them in the 10 days prior to it. Symptoms that occur after the notification date or a long time before hte notification date may have to be removed.\n-   The **treatment**, **digitalization** and **exam** dates, must fall on or within the 60 days after the notification date. If they fall outside this range, they can be coonsidered outliers and may be removed.\n\n# Mapping spatially\n\n### *Notification, Residence & Probable Infection*\n\n![](images/idea-02.png){width=\"25\"} There is of course also spatial data in the data sets. Before diving in deeper it is necessary to download the shapefiles of Brazil municipalities. This can be done via the *geobr* package. However, the municipality code given by geobr is one digit too long and has to be shortened to 6 digits.\n\nIn total, the dataset refers to 3 different locations:\n\n-   **ID_MUNICIP** is the municipality where the case is notified.\n-   **ID_MN_RESI** is the municipality of residence of the patient.\n-   **COMUNINF** is the municipality the patient probably got the infection.\n\n```{r Malaria_LoadMuni, message=FALSE, warning=FALSE}\n# muni <- read_municipality(code_muni = \"all\", year = 2014, showProgress = FALSE) %>%\n#   mutate(code_muni = str_sub(code_muni, end = 6)) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP, dnn = list(\"code_muni\")), responseName = \"noti_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$COMUNINF, dnn = list(\"code_muni\")), responseName = \"infec_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MN_RESI, dnn = list(\"code_muni\")), responseName = \"resi_muni\"))\n```\n\nDepending on what the aim of the study is, each of these variables can be important.\n\n```{r Malaria_plot, message = FALSE, warning = FALSE}\n# cols <- c(\"green\", \"yellow\",\"orange\",\"red\", \"black\") #change these as needed\n# breaks <- c(0, 10, 100, 1000, 10000, 100000) #change these as needed\n# \n# ggplot(muni) +\n#   ggtitle(\"Extra-Amazon malaria per municipality of notification\") +\n#   geom_sf( aes(fill = noti_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_stepsn(breaks = breaks,\n#                     colours = cols,\n#                     values = scales::rescale(breaks))\n# \n# ggplot(muni) +\n#   ggtitle(\"Extra-Amazon malaria per municipality of probable infection\") +\n#   geom_sf(aes(fill = infec_muni), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks,\n#                     colours = cols,\n#                     values = scales::rescale(breaks))\n# \n# ggplot(muni) +\n#   ggtitle(\"Extra-Amazon malaria per municipality of residence\")+\n#   geom_sf( aes(fill = resi_muni), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks,\n#                     colours = cols,\n#                     values = scales::rescale(breaks))\n```\n\n**What did you find after see the maps?** Take a look of the difference between the Extra-Amazon malaria by municipality of notification and probable infection. Almost all malaria notified in the Extra-Amazon region was acquired in the Amazon region. Some people live in the Amazon region were notified in the Extra-Amazon region.\n\n### *Mapping types of Malaria*\n\nIf one wants to map them distinguishing by type, the following code can be used:\n\n```{r Malaria_plotType, message = FALSE, warning = FALSE}\n# muni <- muni %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"V\"], dnn = list(\"code_muni\")), responseName = \"vivax_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"F\"], dnn = list(\"code_muni\")), responseName = \"falci_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"V+F\"], dnn = list(\"code_muni\")), responseName = \"mixed_muni\")) %>%\n#   left_join(as.data.frame(table(malariaData$ID_MUNICIP[malariaData$RES_EXAM == \"other\"], dnn = list(\"code_muni\")), responseName = \"other_muni\"))\n# \n# vivax_plot <- ggplot(muni) +\n#   geom_sf( aes(fill = vivax_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle = paste0(\"Number of P. vivax cases in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# vivax_plot\n# \n# falci_plot <-  ggplot(muni) +\n#   geom_sf( aes(fill = falci_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle=paste0(\"Number of P. falciparum cases in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# falci_plot\n# \n# mixed_plot <-  ggplot(muni) +\n#   geom_sf( aes(fill = mixed_muni), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle=paste0(\"Number of mixed cases in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# mixed_plot\n```\n\n### *Calculating the incidence*\n\nSometimes, having the absolute values is helpful. But other times, the number of cases can be highly dependent on the number of inhabitants and then the incidence or other similar indicator is used. Another reason to use incidence is to make comparable the number of cases between areas and different times. Specifically for malaria, the analogous indicator, the Annual Parasite Index (API) is most common. This indicator is calculated by the number of malaria positive patients occurred in a specific time and place divided by the population per 1.000 inhabitants. This positive patients can be a new case or a relapse. Relapses are most common in malaria *vivax* infection.\n\nFor this, the population data needs to be loaded from [IBGE](https://www.ibge.gov.br/estatisticas/sociais/populacao/9103-estimativas-de-populacao.html?edicao=31451&t=resultados) either manually or using the local function \"get_br_pop_data\" (instructions can be viewed in 0_DownloadData.md).\n\n```{r Malaria_LoadPopulation, message = FALSE}\n# get_br_pop_data(2015, save=F)\n# \n# muni <-  left_join(muni, pop_2015[c(\"code_muni\",\"pop\")], by=\"code_muni\")\n# muni$pop <- as.numeric(muni$pop)\n```\n\nThe incidence is then calculated by dividing the malaria cases by the population of each municipality and multiplication by 1000.\n\n```{r Malaria_Incidence, message = FALSE, warning = FALSE}\n# muni$noti_inc <- muni$noti_muni / muni$pop*1000\n# muni$infec_inc <- muni$infec_muni / muni$pop*1000\n# muni$resi_inc <- muni$resi_muni / muni$pop*1000\n# \n# breaks2 <- c(0, 5, 25, 50, 100, 250)\n# noti_inci_plot <- ggplot(muni) +\n#   ggtitle(\"Incidence of malaria notifications in 2015\")+\n#   geom_sf( aes(fill = noti_inc), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks2,\n#                     colours = cols,\n#                     values = scales::rescale(breaks2))\n# noti_inci_plot\n# \n# infe_inci_plot <- ggplot(muni) +\n#   ggtitle(\"Incidence of probable malaria infections in 2015\")+\n#   geom_sf(aes(fill = infec_inc), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks2,\n#                     colours = cols,\n#                     values = scales::rescale(breaks2))\n# infe_inci_plot\n# \n# resi_inci_plot <- ggplot(muni) +\n#   ggtitle(\"Incidence of residents with malaria in 2015\")+\n#   geom_sf(aes(fill = resi_inc), size = .15, show.legend = TRUE)  +\n#   scale_fill_stepsn(breaks = breaks2,\n#                     colours = cols,\n#                     values = scales::rescale(breaks2))\n# resi_inci_plot\n```\n\nIf one wants to know the incidence depending on the malaria type:\n\n```{r Malaria_TypeIncidence}\n# muni$vivax_inc <- muni$vivax_muni / muni$pop*1000\n# muni$falci_inc <- muni$falci_muni / muni$pop*1000\n# muni$mixed_inc <- muni$mixed_muni / muni$pop*1000\n# \n# vivax_inci_plot <- ggplot(muni) +\n#   geom_sf(aes(fill = vivax_inc), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c() +\n#   labs(subtitle = paste0(\"Vivax incidence in Brazil 2015\"), size = 8) +\n#   theme_minimal()\n# vivax_inci_plot\n# \n# falci_inci_plot<- ggplot(muni) +\n#   geom_sf( aes(fill = falci_inc), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c()+\n#   labs(subtitle = paste0(\"Falciparum incidence in Brazil in 2015\"), size = 8) +\n#   theme_minimal()\n# falci_inci_plot\n# \n# mixed_inci_plot<- ggplot(muni) +\n#   geom_sf( aes(fill = mixed_inc), size = .15, show.legend = TRUE) +\n#   scale_fill_viridis_c()+\n#   labs(subtitle = paste0(\"Mixed incidence in Brazil in 2015\"), size = 8) +\n#   theme_minimal()\n# mixed_inci_plot\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":"github_document","warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":true,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"brazil_malaria.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","editor":"visual","theme":"cosmo","title":"Malaria in Brazil","author":"Daniela Luhrsen, Rachel Lowe and Raquel Lana","date":"2022-11-18","editor_options":{"chunk_output_type":"console"}},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}